<?php 
session_start();
include 'db.php'; 

$token = $_GET['token'] ?? '';
$validToken = false;

// 1. Verify Token validity
if (!empty($token)) {
    $stmt = $conn->prepare("SELECT user_id FROM users WHERE reset_token = ? AND reset_expiry > NOW()");
    $stmt->bind_param("s", $token);
    $stmt->execute();
    $result = $stmt->get_result();
    
    if ($result->num_rows > 0) {
        $validToken = true;
    } else {
        $error = "This password reset link is invalid or has expired.";
    }
} else {
    $error = "No reset token provided.";
}

// 2. Handle Password Update
if(isset($_POST['update_password']) && $validToken) {
    $new_pass = $_POST['password'];
    
    // Hash the new password (Compatible with your fixed login.php)
    $hashed_password = password_hash($new_pass, PASSWORD_DEFAULT);
    
    // Update DB and clear token so it can't be used again
    $update = $conn->prepare("UPDATE users SET password = ?, reset_token = NULL, reset_expiry = NULL WHERE reset_token = ?");
    $update->bind_param("ss", $hashed_password, $token);
    
    if ($update->execute()) {
        header("Location: login.php?msg=password_reset");
        exit();
    } else {
        $error = "Error updating password.";
    }
}
?>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Set New Password</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; background-color: #f4f6f9; margin: 0; }
        .box { background: white; padding: 40px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border-radius: 8px; width: 100%; max-width: 350px; text-align: center; }
        h2 { color: #333; margin-top: 0; }
        input[type="password"] { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        input[type="submit"] { width: 100%; padding: 12px; background-color: #28a745; color: white; border: none; cursor: pointer; font-weight: bold; border-radius: 4px; font-size: 16px; transition: background 0.3s; }
        input[type="submit"]:hover { background-color: #218838; }
        .error { background-color: #ffebee; color: #c62828; padding: 10px; border-radius: 4px; font-size: 14px; margin-bottom: 15px; border: 1px solid #ffcdd2; }
        .back-link { display: block; margin-top: 20px; color: #006ec9; text-decoration: none; font-size: 14px; }
    </style>
</head>
<body>
    <div class="box">
        <h2>New Password</h2>
        <?php if(isset($error)) { echo "<div class='error'>$error</div>"; } ?>

        <?php if($validToken): ?>
            <form method="POST" action="">
                <p style="color:#666; font-size:14px; margin-bottom:20px;">Please enter your new password below.</p>
                <input type="password" name="password" placeholder="Enter new password" required>
                <input type="submit" name="update_password" value="Update Password">
            </form>
        <?php else: ?>
            <p style="color:#666; margin-bottom:20px;">The link you used is not valid.</p>
            <a href="forgot_password.php" class="back-link">Request a new link</a>
        <?php endif; ?>
    </div>
</body>
</html>